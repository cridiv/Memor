package services

import (
	"context"
	"encoding/base64"
	"fmt"
	"os"

	"google.golang.org/genai"
)

func GenerateCardImage(prompt string) (string, error) {
	ctx := context.Background()

	apiKey := os.Getenv("GEMINI_API_KEY")
	if apiKey == "" {
		return "", fmt.Errorf("GEMINI_API_KEY environment variable not set")
	}

	client, err := genai.NewClient(ctx, &genai.ClientConfig{
		APIKey: apiKey,
	})
	if err != nil {
		return "", fmt.Errorf("failed to create Gemini client: %w", err)
	}

	// 'gemini-2.5-flash-image' is the correct model for the new SDK
	const modelName = "gemini-2.5-flash-image"

	config := &genai.GenerateContentConfig{
		ResponseModalities: []string{"IMAGE"},
		// Safety settings are crucial; sometimes the default blocks innocuous things
    SafetySettings: []*genai.SafetySetting{
			{
				Category:  genai.HarmCategoryHarassment,
				Threshold: genai.HarmBlockThresholdBlockNone,
			},
			{
				Category:  genai.HarmCategoryHateSpeech,
				Threshold: genai.HarmBlockThresholdBlockNone,
			},
			{
				Category:  genai.HarmCategorySexuallyExplicit,
				Threshold: genai.HarmBlockThresholdBlockNone,
			},
			{
				Category:  genai.HarmCategoryDangerousContent,
				Threshold: genai.HarmBlockThresholdBlockNone,
			},
		},
	}

	fmt.Println("Sending prompt to Gemini...")
	resp, err := client.Models.GenerateContent(
		ctx,
		modelName,
		genai.Text(prompt),
		config,
	)
	if err != nil {
		return "", fmt.Errorf("Gemini API error: %w", err)
	}

	// 1. Check if the model refused to generate anything
	if len(resp.Candidates) == 0 {
		return "", fmt.Errorf("API returned 0 candidates")
	}

	candidate := resp.Candidates[0]

	// 2. Check for Safety Blocks or other Finish Reasons
	if candidate.FinishReason != "" && candidate.FinishReason != "STOP" {
		fmt.Printf("WARNING: Generation stopped due to: %s\n", candidate.FinishReason)
	}

	var imageData []byte
	var textResponse string

	// 3. Scan parts for BOTH Image and Text (for debugging)
	for _, part := range candidate.Content.Parts {
		if part.InlineData != nil {
			imageData = part.InlineData.Data
			fmt.Printf("Found image data: %d bytes\n", len(imageData))
		}
		if part.Text != "" {
			textResponse += part.Text
		}
	}

	// 4. If no image, return the text error from the model
	if len(imageData) == 0 {
		if textResponse != "" {
			return "", fmt.Errorf("model refused to generate image. Model said: %s", textResponse)
		}
		return "", fmt.Errorf("model returned no image and no text. FinishReason: %s", candidate.FinishReason)
	}

	encoded := base64.StdEncoding.EncodeToString(imageData)
	return "data:image/png;base64," + encoded, nil
}